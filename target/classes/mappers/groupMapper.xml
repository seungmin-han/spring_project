<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inhatc.mapper.GroupMapper">

	<insert id="create" parameterType="com.inhatc.domain.GroupVO" useGeneratedKeys="true" keyProperty="groupSeq">
		insert
			tbl_group
		set 
			groupName = #{groupName}
			, groupText = #{groupText}
			, groupJoinAcceptNy = #{groupJoinAcceptNy}
			, memberSeq = #{memberSeq}
	</insert>
	
	<select id="readOne" resultType="java.util.HashMap">
		<![CDATA[
		SELECT
		  grp.groupSeq
		  , groupJoinAcceptNy
		  , groupName
		  , groupText
		  , IF(grp.MemberSeq = #{memberSeq}, '관리자','') AS groupAdminNyText
		  , grp.memberSeq
		  ,(
			SELECT 
			  COUNT(*) 
			FROM 
			  joinStatus 
			WHERE 
			  groupSeq = grp.groupSeq 
			  AND joinStatusCd = 'Y'  
			GROUP BY 
			  groupSeq 	
		    ) AS memberCount
		  , GROUP_CONCAT(DISTINCT groupTagName SEPARATOR',') AS groupTags
		  , groupImageName 
		FROM
		    tbl_group AS grp
		LEFT JOIN groupImage AS gi ON gi.groupSeq = grp.groupSeq
    	  AND gi.groupImageThumNy = 1
    	LEFT JOIN groupTag AS gt ON gt.groupSeq = grp.groupSeq
		WHERE 
		  grp.groupDelNy = 0
		  AND grp.groupSeq = #{groupSeq}
		GROUP BY
		  grp.groupSeq
		  
		]]>
	</select>
	
	<update id="update">
		UPDATE 
			tbl_group 
		SET
			groupText = #{groupText}
			, groupJoinAcceptNy = #{groupJoinAcceptNy}
		WHERE 
			groupSeq = #{groupSeq}
	</update>
	
	<update id="changeMaster">
		UPDATE
			tbl_group
		SET 
			memberSeq = #{memberSeq}
		WHERE 
			groupSeq = #{groupSeq}
	</update>

	
	<delete id="updateByDelete">
		UPDATE 
			tbl_group
		SET
			groupDelNy = 1 
		WHERE 
			groupSeq = #{groupSeq}
	</delete>
	<select id="readMyList" resultType="java.util.HashMap">
		<![CDATA[
		SELECT
		  grp.groupSeq
		  , groupName
		  , groupText
		  , IF(grp.MemberSeq = #{memberSeq}
          , '관리자','') AS groupAdminNyText
          , IF(grp.MemberSeq = #{memberSeq}
          , 1, 0) AS groupAdminNy
		  , grp.memberSeq
		  ,(
			SELECT 
			  COUNT(*) 
			FROM 
			  joinStatus 
			WHERE 
			  groupSeq = grp.groupSeq 
			  AND joinStatusCd = 'Y'  
			GROUP BY 
			  groupSeq 	
	      ) AS memberCount
		  , CASE
		    WHEN joinStatusCd = 'Y'
		    THEN '가입됨'
		    WHEN joinStatusCd = 'W'
		    THEN '승인대기'
            ELSE NULL
		  END AS joinStatusCdText 
		  , joinStatusCd
		  , joinStatusSeq
		  , GROUP_CONCAT(DISTINCT groupTagName SEPARATOR',') AS groupTags
		  , groupImageName 
		FROM
		    tbl_group AS grp
		INNER JOIN joinStatus AS jst ON grp.groupSeq = jst.groupSeq
          	AND jst.memberSeq =  #{memberSeq}
			AND jst.joinStatusCd != 'N'
        LEFT JOIN groupImage AS gi ON gi.groupSeq = grp.groupSeq
        	AND gi.groupImageThumNy = 1
        LEFT JOIN groupTag AS gt ON gt.groupSeq = grp.groupSeq
		WHERE 
			grp.groupDelNy = 0
        GROUP BY 
        	grp.groupSeq
		]]>
	</select>
	<select id="readAllList" resultType="java.util.HashMap">
		<![CDATA[
		SELECT 
		  grp.groupSeq 
		  , groupName 
		  , groupText
		  , grp.memberSeq 
		  , CASE 
		  	WHEN joinStatusCd = 'Y' 
		  	THEN '가입됨' 
		  	WHEN joinStatusCd = 'W' 
		  	THEN '승인대기' 
		  	ELSE NULL 
		  END AS joinStatusCdText 
		  , joinStatusCd 
		  , (
		    SELECT 
		      COUNT(*) 
		    FROM 
		      joinStatus 
		    WHERE 
		      groupSeq = grp.groupSeq 
		      AND joinStatusCd = 'Y'
		    GROUP BY 
		      groupSeq
		  ) AS memberCount 
		  , GROUP_CONCAT(DISTINCT groupTagName SEPARATOR ',') AS groupTags
		  , groupImageName 
		FROM 
		  tbl_group AS grp 
		  LEFT JOIN joinStatus AS jst ON grp.groupSeq = jst.groupSeq 
		  AND jst.memberSeq = #{memberSeq}
		  LEFT JOIN groupImage AS gi ON gi.groupSeq = grp.groupSeq
        	AND gi.groupImageThumNy = 1
          LEFT JOIN groupTag AS gt ON gt.groupSeq = grp.groupSeq
		WHERE 
		  grp.groupDelNy = 0
		GROUP BY
		  grp.groupSeq
		]]>
	</select>
	<select id="readAllListWithKeyword" resultType="java.util.HashMap" parameterType="Map">
		<![CDATA[
		SELECT 
		  grp.groupSeq 
		  , groupName 
		  , groupText
		  , grp.memberSeq 
		  ,(
			SELECT 
			  COUNT(*) 
			FROM 
			  joinStatus 
			WHERE 
			  groupSeq = grp.groupSeq 
			  AND joinStatusCd = 'Y'  
			GROUP BY 
			  groupSeq 	
		    ) AS memberCount
		  , CASE
		    WHEN joinStatusCd = 'Y'
		    THEN '가입됨'
		    WHEN joinStatusCd = 'W'
		    THEN '승인대기'
		        ELSE NULL
		  END AS joinStatusCdText 
		  , joinStatusCd
		  , GROUP_CONCAT(DISTINCT groupTagName SEPARATOR',') AS groupTags
		  , groupImageName 
		FROM 
		  tbl_group AS grp 
		  LEFT JOIN joinStatus AS jst ON grp.groupSeq = jst.groupSeq 
		  AND jst.memberSeq = #{memberSeq}
		  LEFT JOIN groupImage AS gi ON gi.groupSeq = grp.groupSeq
        	AND gi.groupImageThumNy = 1
          LEFT JOIN groupTag AS gt ON gt.groupSeq = grp.groupSeq 
		WHERE 
		  (
		    groupName LIKE #{keyword}
		    OR groupText LIKE #{keyword}
		    OR groupTagName LIKE #{keyword}
		  ) 
		  AND grp.groupDelNy = 0 
		GROUP BY 
		  grp.groupSeq;
		]]>
	</select>
	<select id="readRecommendList" resultType="java.util.HashMap">
		<![CDATA[
		SELECT 
		  grp.groupSeq 
		  , groupName
		  , groupText 
		  , grp.memberSeq
		  ,(
			SELECT 
			  COUNT(*) 
			FROM 
			  joinStatus 
			WHERE 
			  groupSeq = grp.groupSeq 
			  AND joinStatusCd = 'Y'  
			GROUP BY 
			  groupSeq 	
		    ) AS memberCount
		  , CASE
		    WHEN joinStatusCd = 'Y'
		    THEN '가입됨'
		    WHEN joinStatusCd = 'W'
		    THEN '승인대기'
		        ELSE NULL
		  END AS joinStatusCdText 
		  , joinStatusCd
		  , GROUP_CONCAT(DISTINCT groupTagName SEPARATOR',') AS groupTags
		  , groupImageName 
		FROM 
		  tbl_group AS grp 
		LEFT JOIN joinStatus AS jst ON grp.groupSeq = jst.groupSeq 
		      AND jst.memberSeq = #{memberSeq}
		LEFT JOIN groupImage AS gi ON gi.groupSeq = grp.groupSeq
			  AND gi.groupImageThumNy = 1
		    LEFT JOIN groupTag AS gt ON gt.groupSeq = grp.groupSeq
		WHERE 
		  grp.groupDelNy = 0 
		    AND NOT EXISTS(
		      SELECT 
		        memberSeq 
		      FROM 
		        joinStatus 
		      WHERE 
			    groupSeq = grp.groupSeq
		        AND NOT joinStatusCd = 'N' 
		        AND memberSeq = #{memberSeq}
		  )
		GROUP BY 
		  grp.groupSeq
		]]>
	</select>
	<select id="readJoinedGroup" resultType="com.inhatc.domain.GroupVO">
		SELECT 
			* 
		FROM 
			tbl_group as grp
		INNER JOIN joinStatus as js ON grp.groupSeq = js.groupSeq 
		AND js.memberSeq = #{memberSeq} 
		AND js.joinStatusCd = 'Y'
	</select>
	
</mapper>